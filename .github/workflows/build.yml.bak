name: GDX-Liftoff Build
# .github/workflows/build.yml

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # =========================================================
  # 1Ô∏è‚É£ SETUP DO AMBIENTE
  # =========================================================
  setup:
    name: Setup environment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java 17 (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Ensure Gradle Wrapper executable
        run: chmod +x ./gradlew

      - name: Install required CLI tools
        run: |
          sudo apt-get update
          sudo apt-get install -y tree zip unzip

      - name: Verify Gradle Wrapper
        run: ./gradlew --version

  # =========================================================
  # 2Ô∏è‚É£ BUILD COMPLETO + DEPURA√á√ÉO
  # =========================================================
  build:
    name: Build all platforms
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java 17 (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      # üî• PASSO CR√çTICO ‚Äî instala SDK Android + aceita licen√ßas
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Ensure Gradle Wrapper executable
        run: chmod +x ./gradlew

      # üîΩ Baixa TODAS as depend√™ncias antes de compilar
      - name: Download all Gradle dependencies
        run: ./gradlew --refresh-dependencies

      # üîç Artefato EXTRA de auditoria (estrutura + libs)
      - name: Generate dependency & structure report (Debug)
        run: |
          mkdir -p build/debug-libs
          ./gradlew dependencies > build/debug-libs/dependencies.txt
          tree -a > build/debug-libs/structure.txt
        continue-on-error: true

      - name: Upload debug inspection artifact
        uses: actions/upload-artifact@v4
        with:
          name: debug-libs
          path: build/debug-libs

      # üß† CORE
      - name: Build Core
        run: ./gradlew :core:build

      # ü§ñ ANDROID (Debug APK, sem emulador)
      - name: Build Android
        run: ./gradlew :android:assembleDebug

      # üñ•Ô∏è DESKTOP (LWJGL3)
      - name: Build Desktop (LWJGL3)
        run: ./gradlew :lwjgl3:build

      # üåê HTML / GWT
      - name: Build HTML (GWT Dist)
        run: ./gradlew :html:dist

      # üçé iOS (RoboVM)
      # No Linux apenas valida o Gradle (n√£o gera IPA real)
      - name: Build iOS (RoboVM ‚Äì skipped on Linux)
        run: ./gradlew :ios:build || true

  # =========================================================
  # 3Ô∏è‚É£ PUBLICA√á√ÉO DOS ARTEFATOS
  # =========================================================
  artifacts:
    name: Upload built artifacts
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: android/build/outputs/apk/debug/*.apk

      - name: Upload LWJGL3 JARs
        uses: actions/upload-artifact@v4
        with:
          name: lwjgl3-jar
          path: lwjgl3/build/libs/*.jar

      - name: Upload HTML/GWT Dist
        uses: actions/upload-artifact@v4
        with:
          name: html-dist
          path: html/build/dist/**

      - name: Upload Core JAR
        uses: actions/upload-artifact@v4
        with:
          name: core-jar
          path: core/build/libs/*.jar