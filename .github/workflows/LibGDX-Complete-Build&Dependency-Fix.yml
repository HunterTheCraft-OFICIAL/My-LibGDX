name: LibGDX Complete Build & Dependency Fix
#LibGDX-Complete-Build&Dependency-Fix

on:
  workflow_dispatch:

jobs:
  build-android-desktop:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Set up JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3ï¸âƒ£ Cache Gradle
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4ï¸âƒ£ Grant gradlew permission
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 5ï¸âƒ£ Refresh Gradle dependencies (force backend Android download)
      - name: Refresh all Gradle dependencies
        run: ./gradlew --refresh-dependencies --stacktrace

      # 6ï¸âƒ£ Copy Android natives
      - name: Copy Android natives
        run: ./gradlew :android:copyAndroidNatives --stacktrace

      # 7ï¸âƒ£ Copy backend Android jar
      - name: Copy backend Android JAR
        run: |
          ./gradlew :android:copyBackendJar --stacktrace
          if [ ! -f android/libs/gdx-backend-android-$gdxVersion.jar ]; then
            echo "âŒ Backend JAR nÃ£o encontrado apÃ³s a task, verificar versÃ£o e cache"
            exit 1
          fi

      # 8ï¸âƒ£ Build all modules
      - name: Build all modules
        run: ./gradlew build --stacktrace

      # 9ï¸âƒ£ Upload Android module snapshot
      - name: Upload Android module snapshot
        uses: actions/upload-artifact@v4
        with:
          name: Android-Module-Snapshot
          path: android/
          retention-days: 7

      # ðŸ”Ÿ Upload Android APK
      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: MyGdx-Android
          path: android/build/outputs/apk/debug/*.apk

      # 1ï¸âƒ£1ï¸âƒ£ Upload Desktop JAR
      - name: Upload Desktop JAR
        uses: actions/upload-artifact@v4
        with:
          name: MyGdx-Desktop
          path: desktop/build/libs/*.jar

      # 1ï¸âƒ£2ï¸âƒ£ Upload build logs
      - name: Upload full build log
        run: ./gradlew build --stacktrace --info --debug > full-build-log.txt 2>&1
      - uses: actions/upload-artifact@v4
        with:
          name: Full-Build-Log
          path: full-build-log.txt