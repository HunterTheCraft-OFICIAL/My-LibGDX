name: LibGDX Workflow

on:
  workflow_dispatch:   
  # execução manual
  push:
    branches: [ main ] 
    # dispara em push para main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      # baixa o código do repositório

    - name: Setup JDK
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
      # configura o Java 17 (Temurin)

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        cache-disabled: false
        gradle-home-cache-includes: wrapper,dists,caches
      # habilita cache para wrapper e dependências

    - name: Ensure Gradlew is executable
      run: chmod +x ./gradlew
      # garante permissão de execução para gradlew

    # 1) Checagem + Busca Profunda primeiro
    - name: Check Dependencies (deep-first)
      run: ./gradlew checkDependencies || true
      # nova task: apenas verifica se dependências existem online
      # usa "|| true" para não abortar o job caso alguma falhe
      # gera check-report.txt com status (✅ encontrada, ⚠️ não encontrada)
      # se não encontrar, ativa Busca Profunda e registra última versão oficial

    # 2) Download controlado (pula falhas individuais)
    - name: Download Dependencies
      run: ./gradlew downloadDependencies || true
      # baixa dependências que foram resolvidas, pula falhas
      # gera download-report.txt (✅ sucesso, ⚠️ não encontrada, ❌ falha)

    # 3) Relatório consolidado
    - name: Generate Reports
      run: ./gradlew generateReport
      # une check + download em libs-report.txt para facilitar leitura

    # 4) Decisão: só buildar se ao menos 1 dependência foi baixada
    - name: Decide Build
      id: decide_build
      shell: bash
      run: |
        echo "Verificando sucesso no download..."
        if [ -f build/download-report.txt ]; then
          # Se contém a mensagem de erro final e nenhum ✅, considera zero sucesso
          if grep -q "Nenhuma dependência foi baixada com sucesso" build/download-report.txt && ! grep -q "✅ Sucesso:" build/download-report.txt; then
            echo "Nenhuma dependência baixada com sucesso. Build será pulado."
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "Há dependências baixadas com sucesso. Build será executado."
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "Relatório de download não encontrado. Build será pulado por segurança."
          echo "should_build=false" >> $GITHUB_OUTPUT
        fi
      # determina se o build deve rodar, baseado no relatório

    # 5) Build condicional com Gradle 9 (fallback para 8.7)
    - name: Build with Gradle 9 (fallback to 8.7)
      if: steps.decide_build.outputs.should_build == 'true'
      run: |
        set -e
        echo "Tentando Gradle v9..."
        if ./gradlew build --refresh-dependencies; then
          echo "Gradle v9 OK"
        else
          echo "Gradle v9 falhou, tentando v8.7..."
          sed -i 's/gradle-9\.0\.0-bin\.zip/gradle-8.7-bin.zip/' gradle/wrapper/gradle-wrapper.properties
          ./gradlew build --refresh-dependencies
        fi
      # tenta rodar com Gradle 9, se falhar troca para 8.7
      # só executa se should_build == true

    # 6) Upload dos artefatos sempre (mesmo se não buildar)
    - name: Upload All Libs
      uses: actions/upload-artifact@v4
      with:
        name: libgdx-libs
        path: build/all-libs/
      # artefato com todas as libs juntas

    - name: Upload Individual Libs
      uses: actions/upload-artifact@v4
      with:
        name: libgdx-individual
        path: build/libs-individual/
      # artefatos com libs separadas + relatórios individuais

    - name: Upload Reports
      uses: actions/upload-artifact@v4
      with:
        name: libgdx-reports
        path: build/libs-report.txt
      # relatório geral consolidado (check + download)