name: LibGDX Backends & Natives Builder

on:
  workflow_dispatch:

env:
  LIBGDX_VERSION: 1.14.0

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Clone libGDX
        run: |
          git clone --branch $LIBGDX_VERSION https://github.com/libgdx/libgdx.git libgdx-src

      - name: Build core and backends
        working-directory: libgdx-src
        run: |
          ./gradlew \
            :gdx:build \
            :backends:gdx-backend-lwjgl3:build \
            :backends:gdx-backend-android:assembleRelease

      - name: Prepare directory structure
        run: |
          mkdir -p libgdx-pronto/{core,desktop/{backend,natives/{windows,linux,macos}},android/{backend,jniLibs}}

      # ======================
      # CORE
      # ======================
      - name: Copy core jars
        run: |
          cp libgdx-src/gdx/build/libs/*.jar libgdx-pronto/core/

      # ======================
      # DESKTOP
      # ======================
      - name: Copy desktop backend
        run: |
          cp libgdx-src/backends/gdx-backend-lwjgl3/build/libs/*.jar \
             libgdx-pronto/desktop/backend/

      - name: Resolve and extract desktop natives (LWJGL)
        run: |
          cd libgdx-src
          ./gradlew :backends:gdx-backend-lwjgl3:dependencies --configuration runtimeClasspath

          find ~/.gradle/caches -name "*lwjgl*natives-windows*.jar" -exec unzip -o {} -d natives-win \;
          find ~/.gradle/caches -name "*lwjgl*natives-linux*.jar" -exec unzip -o {} -d natives-linux \;
          find ~/.gradle/caches -name "*lwjgl*natives-macos*.jar" -exec unzip -o {} -d natives-macos \;

          cp natives-win/*.dll libgdx-pronto/desktop/natives/windows/ || true
          cp natives-linux/*.so libgdx-pronto/desktop/natives/linux/ || true
          cp natives-macos/*.dylib libgdx-pronto/desktop/natives/macos/ || true

      # ======================
      # ANDROID
      # ======================
      - name: Copy android backend
        run: |
          cp libgdx-src/backends/gdx-backend-android/build/outputs/aar/*.aar \
             libgdx-pronto/android/backend/

      - name: Extract android natives
        run: |
          mkdir android-aar
          unzip libgdx-pronto/android/backend/*.aar -d android-aar

          for abi in armeabi-v7a arm64-v8a x86 x86_64; do
            mkdir -p libgdx-pronto/android/jniLibs/$abi
            cp android-aar/jni/$abi/*.so libgdx-pronto/android/jniLibs/$abi/ || true
          done

      # ======================
      # README
      # ======================
      - name: Create README
        run: |
          cat <<EOF > libgdx-pronto/README.txt
          LibGDX Backends & Natives - ${LIBGDX_VERSION}

          Conteúdo:
          - core: libGDX core
          - desktop/backend: LWJGL3 backend
          - desktop/natives: natives por SO
          - android/backend: AAR oficial
          - android/jniLibs: natives por ABI

          Gerado automaticamente a partir do código-fonte oficial do libGDX.
          EOF

      # ======================
      # ARTIFACT
      # ======================
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libgdx-backends-natives-${{ env.LIBGDX_VERSION }}
          path: libgdx-pronto