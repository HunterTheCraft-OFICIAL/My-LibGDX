name: LibGDX Workflow

on:
  workflow_dispatch:   
  # execução manual
  push:
    branches: [ main ] 
    # dispara em push para main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      # baixa o código do repositório

    - name: Setup JDK
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
      # configura o Java 17 (Temurin)

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        cache-disabled: false
        gradle-home-cache-includes: wrapper,dists,caches
      # habilita cache para wrapper e dependências

    - name: Ensure Gradlew is executable
      run: chmod +x ./gradlew
      # garante permissão de execução para gradlew

    - name: Build with Gradle 9 (fallback to 8.7)
      run: |
        set -e
        echo "Tentando Gradle v9..."
        if ./gradlew build --refresh-dependencies; then
          echo "Gradle v9 OK"
        else
          echo "Gradle v9 falhou, tentando v8.7..."
          sed -i 's/gradle-9\.0\.0-bin\.zip/gradle-8.7-bin.zip/' gradle/wrapper/gradle-wrapper.properties
          ./gradlew build --refresh-dependencies
        fi
      # tenta rodar com Gradle 9, se falhar troca para 8.7

    - name: Check Dependencies
      run: ./gradlew checkDependencies
      # nova task: apenas verifica se dependências existem online
      # gera check-report.txt com status (✅ encontrada, ⚠️ não encontrada)
      # só falha se nenhuma dependência for encontrada

    - name: Download Dependencies
      run: ./gradlew downloadDependencies
      # nova task: baixa dependências, pula falhas individuais
      # gera download-report.txt com status (✅ sucesso, ⚠️ não encontrada, ❌ falha)

    - name: Generate Reports
      run: ./gradlew generateReport
      # gera relatório consolidado (check + download) em libs-report.txt
      # inclui informações da versão pedida e última versão oficial encontrada

    - name: Upload All Libs
      uses: actions/upload-artifact@v4
      with:
        name: libgdx-libs
        path: build/all-libs/
      # artefato com todas as libs juntas

    - name: Upload Individual Libs
      uses: actions/upload-artifact@v4
      with:
        name: libgdx-individual
        path: build/libs-individual/
      # artefatos com libs separadas + relatórios individuais

    - name: Upload Reports
      uses: actions/upload-artifact@v4
      with:
        name: libgdx-reports
        path: build/libs-report.txt
      # relatório geral consolidado (check + download)