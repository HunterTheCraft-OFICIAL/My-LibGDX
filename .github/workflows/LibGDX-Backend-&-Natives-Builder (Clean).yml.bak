name: LibGDX – Build completo e artefato filtrável

on:
  workflow_dispatch:
    inputs:
      preset:
        description: "Preset de pacote"
        type: choice
        options: [core, desktop, android, full]
        default: full

      android:
        type: boolean
        default: true

      desktop:
        type: boolean
        default: true

      ios:
        type: boolean
        default: false

      html:
        type: boolean
        default: false

      extensions:
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout do repositório
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2️⃣ Setup do Java
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 3️⃣ Permissão para Gradle
      - name: Grant execute permission for Gradle
        run: chmod +x ./libgdx-src/gradlew

      # 4️⃣ Build COMPLETO (sempre igual, sem condições)
      - name: Build all LibGDX modules
        working-directory: libgdx-src
        run: ./gradlew build

      # 5️⃣ Preparação da estrutura do artefato
      - name: Prepare artifact structure
        run: |
          ROOT=artifact/libgdx

          mkdir -p $ROOT
          mkdir -p $ROOT/backends
          mkdir -p $ROOT/extensions
          mkdir -p $ROOT/natives
          mkdir -p $ROOT/tools

          # Core
          cp libgdx-src/gdx/build/libs/*.jar $ROOT || true

          # Backends
          cp -r libgdx-src/backends $ROOT/ || true

          # Extensions
          cp -r libgdx-src/extensions $ROOT/ || true

          # Tools
          cp -r libgdx-src/extensions/gdx-tools/build/libs $ROOT/tools || true

          # Platform natives (se existirem)
          cp -r libgdx-src/gdx-platform/build/natives $ROOT/ || true

      # 6️⃣ FILTRO DO ARTEFATO (botões atuam AQUI)
      - name: Filter artifact content
        run: |
          ROOT=artifact/libgdx

          if [ "${{ github.event.inputs.android }}" != "true" ]; then
            rm -rf $ROOT/backends/android
            rm -rf $ROOT/natives/android
          fi

          if [ "${{ github.event.inputs.desktop }}" != "true" ]; then
            rm -rf $ROOT/backends/desktop
            rm -rf $ROOT/natives/desktop
          fi

          if [ "${{ github.event.inputs.ios }}" != "true" ]; then
            rm -rf $ROOT/backends/ios
            rm -rf $ROOT/backends/ios-metalangle
          fi

          if [ "${{ github.event.inputs.html }}" != "true" ]; then
            rm -rf $ROOT/backends/html
          fi

          if [ "${{ github.event.inputs.extensions }}" != "true" ]; then
            rm -rf $ROOT/extensions
          fi

      # 7️⃣ Upload do artefato final
      - name: Upload LibGDX artifact
        uses: actions/upload-artifact@v4
        with:
          name: libgdx-complete-1.14.0
          path: artifact