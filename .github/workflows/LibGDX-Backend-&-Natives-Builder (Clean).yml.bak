name: LibGDX Backends & Natives Builder (Option A)

on:
  workflow_dispatch:

env:
  LIBGDX_VERSION: 1.14.0

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Clone official libGDX source
        run: |
          git clone --branch $LIBGDX_VERSION https://github.com/libgdx/libgdx.git libgdx-src

      - name: Build libGDX core and backends
        working-directory: libgdx-src
        run: |
          ./gradlew \
            :gdx:build \
            :backends:gdx-backend-android:assembleRelease \
            :backends:gdx-backend-lwjgl3:build

      - name: Prepare artifact structure
        run: |
          set -e

          ROOT=libgdx-backends-natives-${LIBGDX_VERSION}

          mkdir -p $ROOT/core
          mkdir -p $ROOT/android/backend
          mkdir -p $ROOT/android/natives
          mkdir -p $ROOT/desktop/backend
          mkdir -p $ROOT/desktop/natives/{windows,linux,macos}

          # -------- CORE --------
          cp libgdx-src/gdx/build/libs/gdx-*-javadoc.jar $ROOT/core/
          cp libgdx-src/gdx/build/libs/gdx-*-sources.jar $ROOT/core/
          cp libgdx-src/gdx/build/libs/gdx-*.jar $ROOT/core/

          for f in $ROOT/core/*SNAPSHOT*.jar; do
            mv "$f" "${f/SNAPSHOT/${LIBGDX_VERSION}}"
          done

          # -------- ANDROID BACKEND + NATIVES --------
          AAR=$(ls libgdx-src/backends/gdx-backend-android/build/outputs/aar/*.aar | head -n 1)
          cp "$AAR" /tmp/android-backend.aar
          unzip -q /tmp/android-backend.aar -d /tmp/android-aar

          cp /tmp/android-aar/classes.jar $ROOT/android/backend/gdx-backend-android.jar

          if [ -d /tmp/android-aar/jni ]; then
            cp -r /tmp/android-aar/jni/* $ROOT/android/natives/
          fi

          # -------- DESKTOP BACKEND --------
          cp libgdx-src/backends/gdx-backend-lwjgl3/build/libs/gdx-backend-lwjgl3-*.jar \
             $ROOT/desktop/backend/

          for f in $ROOT/desktop/backend/*SNAPSHOT*.jar; do
            mv "$f" "${f/SNAPSHOT/${LIBGDX_VERSION}}"
          done

          # -------- DESKTOP NATIVES --------
          cp libgdx-src/gdx-platform/build/natives/*windows*.dll \
             $ROOT/desktop/natives/windows/ || true

          cp libgdx-src/gdx-platform/build/natives/*linux*.so \
             $ROOT/desktop/natives/linux/ || true

          cp libgdx-src/gdx-platform/build/natives/*macos*.dylib \
             $ROOT/desktop/natives/macos/ || true

          # -------- README --------
 cat > $ROOT/README.txt << 'EOF'
LibGDX Backends & Natives – Manual Package

✔ Official libGDX source
✔ No third-party modifications
✔ Prepared for manual usage (no Gradle required)

Structure:
- core/                 → libGDX core
- android/backend/      → Android backend (.jar)
- android/natives/      → Android native libraries (.so)
- desktop/backend/      → LWJGL3 backend
- desktop/natives/      → Desktop natives per OS

This package is intended for:
- Manual integration
- Existing project updates
- Educational and experimental usage

Generated via GitHub Actions.
EOF
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libgdx-backends-natives-${{ env.LIBGDX_VERSION }}
          path: libgdx-backends-natives-${{ env.LIBGDX_VERSION }}