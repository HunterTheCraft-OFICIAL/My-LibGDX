name: LibGDX Backend & Natives Builder (Final)

on:
  workflow_dispatch:

env:
  LIBGDX_VERSION: "1.14.0"
  JAVA_VERSION: "17"

jobs:
  build-libgdx:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repo
        uses: actions/checkout@v4

      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: üì¶ Restore Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-libgdx-${{ env.LIBGDX_VERSION }}

      - name: üì• Clone libGDX (official)
        run: |
          git clone --depth 1 --branch $LIBGDX_VERSION https://github.com/libgdx/libgdx.git libgdx-src

      - name: üßπ Clean libGDX
        working-directory: libgdx-src
        run: ./gradlew clean

      - name: üèóÔ∏è Build core + backends
        working-directory: libgdx-src
        run: |
          ./gradlew \
            gdx:build \
            backends:gdx-backend-lwjgl3:build \
            backends:gdx-backend-android:build

      - name: üß± Prepare fake SDK structure
        run: |
          mkdir -p libgdx-pronto/{core,desktop/android,android/libs,android/jniLibs}
          mkdir -p libgdx-pronto/desktop/natives/{windows,linux,macos}
          mkdir -p libgdx-pronto/android/jniLibs/{armeabi-v7a,arm64-v8a,x86,x86_64}

      # ---------- CORE ----------
      - name: üì¶ Collect CORE jars
        run: |
          cp libgdx-src/gdx/build/libs/*.jar libgdx-pronto/core/

      # ---------- DESKTOP ----------
      - name: üñ•Ô∏è Collect DESKTOP backend
        run: |
          cp libgdx-src/backends/gdx-backend-lwjgl3/build/libs/*.jar libgdx-pronto/desktop/

      # ---------- ANDROID BACKEND ----------
      - name: ü§ñ Collect ANDROID backend
        run: |
          cp libgdx-src/backends/gdx-backend-android/build/libs/*.jar libgdx-pronto/android/libs/

      # ---------- ANDROID NATIVES ----------
      - name: üì± Extract ANDROID natives (.so)
        run: |
          for jar in libgdx-src/backends/gdx-backend-android/build/libs/*.jar; do
            unzip -o "$jar" "lib/**/*.so" -d tmp-natives || true
          done

          find tmp-natives -name "*.so" | while read so; do
            if [[ "$so" == *"armeabi-v7a"* ]]; then
              cp "$so" libgdx-pronto/android/jniLibs/armeabi-v7a/
            elif [[ "$so" == *"arm64-v8a"* ]]; then
              cp "$so" libgdx-pronto/android/jniLibs/arm64-v8a/
            elif [[ "$so" == *"x86_64"* ]]; then
              cp "$so" libgdx-pronto/android/jniLibs/x86_64/
            elif [[ "$so" == *"x86"* ]]; then
              cp "$so" libgdx-pronto/android/jniLibs/x86/
            fi
          done

      # ---------- README ----------
      - name: üìù Generate README
        run: |
          cat <<EOF > libgdx-pronto/README.txt
          LibGDX Offline SDK - $LIBGDX_VERSION

          Conte√∫do:
          - core/: gdx.jar + sources
          - desktop/: backend LWJGL3
          - desktop/natives/: (estrutura pronta)
          - android/libs/: backend android
          - android/jniLibs/: nativos por ABI

          Todos os arquivos foram compilados a partir do reposit√≥rio oficial:
          https://github.com/libgdx/libgdx

          Nenhum bin√°rio foi obtido via Maven Central.
          EOF

      # ---------- SUMMARY ----------
      - name: üìä Build Summary
        run: |
          echo "## üß© LibGDX Offline SDK Build" >> $GITHUB_STEP_SUMMARY
          echo "- Version: $LIBGDX_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- Core JARs: $(ls libgdx-pronto/core | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Desktop JARs: $(ls libgdx-pronto/desktop | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Android JARs: $(ls libgdx-pronto/android/libs | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Android natives:" >> $GITHUB_STEP_SUMMARY
          for abi in armeabi-v7a arm64-v8a x86 x86_64; do
            echo "  - $abi: $(ls libgdx-pronto/android/jniLibs/$abi 2>/dev/null | wc -l) .so" >> $GITHUB_STEP_SUMMARY
          done

      - name: üì§ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libgdx-pronto-${{ env.LIBGDX_VERSION }}
          path: libgdx-pronto/