name: LibGDX Backend & Natives Builder (Selectable)

on:
  workflow_dispatch:
    inputs:
      preset:
        description: "Preset rÃ¡pido"
        required: true
        default: "basic"
        type: choice
        options:
          - basic
          - custom
          - full

      platform_android:
        description: "Android"
        type: boolean
        default: true

      platform_desktop:
        description: "Desktop (LWJGL3)"
        type: boolean
        default: true

      platform_html:
        description: "HTML (GWT)"
        type: boolean
        default: false

      platform_ios:
        description: "iOS (RoboVM)"
        type: boolean
        default: false

      ext_box2d:
        description: "gdx-box2d"
        type: boolean
        default: false

      ext_bullet:
        description: "gdx-bullet"
        type: boolean
        default: false

      ext_freetype:
        description: "gdx-freetype"
        type: boolean
        default: false

      ext_tools:
        description: "gdx-tools"
        type: boolean
        default: false

      ext_angle:
        description: "gdx-lwjgl3-angle"
        type: boolean
        default: false

env:
  LIBGDX_VERSION: 1.14.0

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Clone libGDX
        run: |
          git clone --branch $LIBGDX_VERSION https://github.com/libgdx/libgdx.git libgdx-src

      - name: Resolve selections
        id: select
        run: |
          PRESET="${{ github.event.inputs.preset }}"

          if [ "$PRESET" = "basic" ]; then
            ANDROID=true
            DESKTOP=true
            HTML=false
            IOS=false
            BOX2D=false
            BULLET=false
            FREETYPE=false
            TOOLS=false
            ANGLE=false
          elif [ "$PRESET" = "full" ]; then
            ANDROID=true
            DESKTOP=true
            HTML=true
            IOS=true
            BOX2D=true
            BULLET=true
            FREETYPE=true
            TOOLS=true
            ANGLE=true
          else
            ANDROID=${{ github.event.inputs.platform_android }}
            DESKTOP=${{ github.event.inputs.platform_desktop }}
            HTML=${{ github.event.inputs.platform_html }}
            IOS=${{ github.event.inputs.platform_ios }}
            BOX2D=${{ github.event.inputs.ext_box2d }}
            BULLET=${{ github.event.inputs.ext_bullet }}
            FREETYPE=${{ github.event.inputs.ext_freetype }}
            TOOLS=${{ github.event.inputs.ext_tools }}
            ANGLE=${{ github.event.inputs.ext_angle }}
          fi

          echo "ANDROID=$ANDROID" >> $GITHUB_ENV
          echo "DESKTOP=$DESKTOP" >> $GITHUB_ENV
          echo "HTML=$HTML" >> $GITHUB_ENV
          echo "IOS=$IOS" >> $GITHUB_ENV
          echo "BOX2D=$BOX2D" >> $GITHUB_ENV
          echo "BULLET=$BULLET" >> $GITHUB_ENV
          echo "FREETYPE=$FREETYPE" >> $GITHUB_ENV
          echo "TOOLS=$TOOLS" >> $GITHUB_ENV
          echo "ANGLE=$ANGLE" >> $GITHUB_ENV

      - name: Build selected modules
        working-directory: libgdx-src
        run: |
          ./gradlew :gdx:build

          if [ "$ANDROID" = "true" ]; then
            ./gradlew :backends:gdx-backend-android:assembleRelease
          fi

          if [ "$DESKTOP" = "true" ]; then
            ./gradlew :backends:gdx-backend-lwjgl3:build
          fi

          if [ "$HTML" = "true" ]; then
            ./gradlew :backends:gdx-backend-gwt:build
          fi

          if [ "$IOS" = "true" ]; then
            ./gradlew :backends:gdx-backend-robovm:build
          fi

          if [ "$BOX2D" = "true" ]; then
            ./gradlew :extensions:gdx-box2d:gdx-box2d:build
          fi

          if [ "$BULLET" = "true" ]; then
            ./gradlew :extensions:gdx-bullet:build
          fi

          if [ "$FREETYPE" = "true" ]; then
            ./gradlew :extensions:gdx-freetype:build
          fi

          if [ "$TOOLS" = "true" ]; then
            ./gradlew :extensions:gdx-tools:build
          fi

          if [ "$ANGLE" = "true" ]; then
            ./gradlew :extensions:gdx-lwjgl3-angle:build
          fi

      - name: Prepare artifact
        run: |
          mkdir -p libgdx-artifact/{core,android,desktop,html,ios,extensions,natives/{windows,linux,macos}}

          cp libgdx-src/gdx/build/libs/*.jar libgdx-artifact/core/

          [ "$ANDROID" = "true" ] && cp libgdx-src/backends/gdx-backend-android/build/outputs/aar/*.aar libgdx-artifact/android/ || true
          [ "$DESKTOP" = "true" ] && cp libgdx-src/backends/gdx-backend-lwjgl3/build/libs/*.jar libgdx-artifact/desktop/ || true

          cp libgdx-src/backends/gdx-backend-lwjgl3/build/natives/*windows*.jar libgdx-artifact/natives/windows/ || true
          cp libgdx-src/backends/gdx-backend-lwjgl3/build/natives/*linux*.jar libgdx-artifact/natives/linux/ || true
          cp libgdx-src/backends/gdx-backend-lwjgl3/build/natives/*macos*.jar libgdx-artifact/natives/macos/ || true

          cp libgdx-src/extensions/**/build/libs/*.jar libgdx-artifact/extensions/ || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libgdx-backends-natives-${{ env.LIBGDX_VERSION }}
          path: libgdx-artifact