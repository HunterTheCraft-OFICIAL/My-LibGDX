name: LibGDX Complete Backends & Extensions Builder (Option A)

on:
  workflow_dispatch:

env:
  LIBGDX_VERSION: 1.14.0

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Clone official libGDX source
        run: |
          git clone --branch $LIBGDX_VERSION https://github.com/libgdx/libgdx.git libgdx-src

      - name: Build libGDX core and backends
        working-directory: libgdx-src
        run: |
          ./gradlew \
            :gdx:build \
            :backends:gdx-backend-android:assembleRelease \
            :backends:gdx-backend-lwjgl3:build \
            :backends:gdx-backend-lwjgl:build \
            :backends:gdx-backend-headless:build \
            :backends:gdx-backend-robovm:build \
            :backends:gdx-backend-robovm-metalangle:build

      - name: Prepare artifact structure
        run: |
          set -e
          ROOT=libgdx-complete-${LIBGDX_VERSION}

          # Core
          mkdir -p $ROOT/core
          cp libgdx-src/gdx/build/libs/gdx-*.jar $ROOT/core/
          cp libgdx-src/gdx/build/libs/gdx-*-sources.jar $ROOT/core/
          cp libgdx-src/gdx/build/libs/gdx-*-javadoc.jar $ROOT/core/
          for f in $ROOT/core/*SNAPSHOT*.jar; do
            mv "$f" "${f/SNAPSHOT/${LIBGDX_VERSION}}"
          done

          # Backends
          mkdir -p $ROOT/backends/android
          mkdir -p $ROOT/backends/desktop/{lwjgl,lwjgl3,headless}
          mkdir -p $ROOT/backends/ios
          mkdir -p $ROOT/backends/ios-metalangle

          # Android
          AAR=$(ls libgdx-src/backends/gdx-backend-android/build/outputs/aar/*.aar | head -n1)
          cp "$AAR" $ROOT/backends/android/gdx-backend-android-${LIBGDX_VERSION}.aar
          cp libgdx-src/backends/gdx-backend-android/build/libs/gdx-backend-android-*.jar \
             $ROOT/backends/android/gdx-backend-android-${LIBGDX_VERSION}.jar

          # Desktop
          for backend in lwjgl lwjgl3 headless; do
            mkdir -p $ROOT/backends/desktop/$backend
            cp libgdx-src/backends/gdx-backend-$backend/build/libs/gdx-backend-$backend-*.jar \
               $ROOT/backends/desktop/$backend/
            for f in $ROOT/backends/desktop/$backend/*SNAPSHOT*.jar; do
              mv "$f" "${f/SNAPSHOT/${LIBGDX_VERSION}}"
            done
          done

          # iOS
          for ios_backend in robovm robovm-metalangle; do
            mkdir -p $ROOT/backends/$ios_backend
            cp libgdx-src/backends/gdx-backend-$ios_backend/build/libs/gdx-backend-$ios_backend-*.jar \
               $ROOT/backends/$ios_backend/
          done

          # Extensions
          mkdir -p $ROOT/extensions
          for ext in box2d bullet freetype lwjgl3-angle tools; do
            mkdir -p $ROOT/extensions/$ext
            cp libgdx-src/extensions/$ext/build/libs/*.jar $ROOT/extensions/$ext/
            for f in $ROOT/extensions/$ext/*SNAPSHOT*.jar; do
              mv "$f" "${f/SNAPSHOT/${LIBGDX_VERSION}}"
            done
          done

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libgdx-complete-${{ env.LIBGDX_VERSION }}
          path: libgdx-complete-${{ env.LIBGDX_VERSION }}