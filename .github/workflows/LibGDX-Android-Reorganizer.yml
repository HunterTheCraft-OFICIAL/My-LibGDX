name: LibGDX – Build completo + SDK + Projeto organizado

on:
  workflow_dispatch:
    inputs:

      ####################################
      # PLATAFORMAS (DEBUG / VALIDAÇÃO)
      ####################################
      desktop:
        description: "Desktop"
        type: boolean
        default: true

      android:
        description: "Android"
        type: boolean
        default: true

      html:
        description: "HTML"
        type: boolean
        default: true

      ios:
        description: "iOS"
        type: boolean
        default: true

      ####################################
      # EXTENSÕES (DEBUG / VALIDAÇÃO)
      ####################################
      box2d:
        description: "Box2D"
        type: boolean
        default: true

      freetype:
        description: "FreeType"
        type: boolean
        default: true

      controllers:
        description: "Controllers"
        type: boolean
        default: true

      ####################################
      # VERSÃO (INFORMATIVA)
      ####################################
      libgdx_version:
        description: "Versão do libGDX"
        type: choice
        options: [1.12.0, 1.13.0, 1.14.0]
        default: 1.14.0

env:
  LIBGDX_VERSION: 1.14.0

permissions:
  contents: read
  actions: read

jobs:
  ####################################
  # JOB 1 — BUILD BRUTO
  ####################################
  build-raw:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Clone libGDX
        run: |
          git clone --branch $LIBGDX_VERSION https://github.com/libgdx/libgdx.git libgdx-src

      - name: Grant Gradle permission
        run: chmod +x libgdx-src/gradlew

      - name: Build libGDX (full)
        working-directory: libgdx-src
        run: ./gradlew build

      - name: Prepare raw artifact
        run: |
          ROOT=artifact/libgdx
          mkdir -p $ROOT

          cp libgdx-src/gdx/build/libs/*.jar $ROOT/ || true
          cp -r libgdx-src/backends $ROOT/ || true
          cp -r libgdx-src/extensions $ROOT/ || true
          cp -r libgdx-src/gdx-platform/build/natives $ROOT/ || true

      - name: Upload raw artifact
        uses: actions/upload-artifact@v4
        with:
          name: libgdx-raw
          path: artifact

  ####################################
  # JOB 2 — SDK ORGANIZADO
  ####################################
  organize-sdk:
    needs: build-raw
    runs-on: ubuntu-latest

    steps:
      - name: Download raw artifact
        uses: actions/download-artifact@v4
        with:
          name: libgdx-raw
          path: input

      - name: Create SDK structure
        run: |
          SDK=output/libgdx-sdk
          mkdir -p \
            $SDK/core \
            $SDK/backends/{desktop,android,html,ios} \
            $SDK/extensions \
            $SDK/natives/{desktop,android}

          # Core
          cp input/libgdx/gdx-*.jar $SDK/core/ || true

          # Backends
          cp input/libgdx/backends/gdx-backend-lwjgl*/build/libs/*.jar $SDK/backends/desktop/ || true
          cp input/libgdx/backends/gdx-backend-android/build/outputs/aar/*.aar $SDK/backends/android/ || true
          cp -r input/libgdx/backends/gdx-backends-gwt $SDK/backends/html/ || true
          cp -r input/libgdx/backends/gdx-backend-robovm* $SDK/backends/ios/ || true

          # Extensions
          cp -r input/libgdx/extensions/* $SDK/extensions/ || true

          # Desktop natives
          cp -r input/libgdx/natives/* $SDK/natives/desktop/ || true

          # Android natives (preserva nomes antigos)
          find input -name "*.so" | while read so; do
            ABI=$(echo "$so" | grep -oE 'armeabi-v7a|arm64-v8a|x86|x86_64')
            if [ -n "$ABI" ]; then
              mkdir -p $SDK/natives/android/$ABI
              cp "$so" $SDK/natives/android/$ABI/
            fi
          done

      - name: Upload SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: libgdx-sdk-organizado
          path: output

  ####################################
  # JOB 3 — ESTRUTURA DE PROJETO REAL
  ####################################
  organize-project:
    needs: organize-sdk
    runs-on: ubuntu-latest

    steps:
      - name: Download SDK artifact
        uses: actions/download-artifact@v4
        with:
          name: libgdx-sdk-organizado
          path: input

      - name: Create project-like structure
        run: |
          ROOT=output/project
          mkdir -p \
            $ROOT/core/libs \
            $ROOT/desktop/libs \
            $ROOT/android/libs \
            $ROOT/android/src/main/jniLibs

          # Core jars
          cp input/libgdx-sdk/core/*.jar $ROOT/core/libs/ || true
          cp input/libgdx-sdk/extensions/**/*.jar $ROOT/core/libs/ || true

          # Desktop
          cp input/libgdx-sdk/backends/desktop/*.jar $ROOT/desktop/libs/ || true
          cp input/libgdx-sdk/natives/desktop/**/* $ROOT/desktop/libs/ || true

          # Android jars
          cp input/libgdx-sdk/backends/android/* $ROOT/android/libs/ || true

          # Android natives (AIDE / legado)
          cp -r input/libgdx-sdk/natives/android/* $ROOT/android/src/main/jniLibs/ || true

      - name: Upload project structure artifact
        uses: actions/upload-artifact@v4
        with:
          name: libgdx-project-structure
          path: output