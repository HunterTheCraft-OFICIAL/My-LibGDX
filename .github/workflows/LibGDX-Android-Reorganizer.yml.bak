name: LibGDX – Build completo + SDK organizado

on:
  workflow_dispatch:
    inputs:

      ####################################
      # PLATAFORMAS (APENAS DIAGNÓSTICO)
      ####################################

      platform_preset:
        description: "Pré-configuração de Plataforma (diagnóstico)"
        type: choice
        options: [basico, completo, personalizado]
        default: completo

      desktop:
        description: "Desktop (diagnóstico)"
        type: boolean
        default: true

      android:
        description: "Android (diagnóstico)"
        type: boolean
        default: true

      html:
        description: "HTML / GWT (diagnóstico)"
        type: boolean
        default: false

      ios:
        description: "iOS (diagnóstico)"
        type: boolean
        default: false

      ####################################
      # EXTENSÕES (APENAS DIAGNÓSTICO)
      ####################################

      extension_preset:
        description: "Pré-configuração de Extensões (diagnóstico)"
        type: choice
        options: [nenhum, basico, completo, personalizado]
        default: completo

      box2d:
        description: "Box2D (diagnóstico)"
        type: boolean
        default: true

      freetype:
        description: "FreeType (diagnóstico)"
        type: boolean
        default: true

      controllers:
        description: "Controllers (diagnóstico)"
        type: boolean
        default: true

      tools:
        description: "gdx-tools (diagnóstico)"
        type: boolean
        default: true

      ####################################
      # VERSÃO
      ####################################

      libgdx_version:
        description: "Versão do libGDX"
        type: choice
        options: [1.12.0, 1.13.0, 1.14.0]
        default: 1.14.0

env:
  LIBGDX_VERSION: 1.14.0

permissions:
  contents: read

jobs:
  build-sdk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Clone libGDX
        run: |
          git clone --branch $LIBGDX_VERSION https://github.com/libgdx/libgdx.git libgdx-src
          chmod +x libgdx-src/gradlew

      - name: Build libGDX (FULL)
        working-directory: libgdx-src
        run: ./gradlew build

      ####################################
      # ARTEFATO BRUTO (DEBUG)
      ####################################

      - name: Create raw artifact
        run: |
          RAW=artifact/raw/libgdx
          mkdir -p $RAW
          cp -r libgdx-src/* $RAW/

      - name: Upload raw artifact
        uses: actions/upload-artifact@v4
        with:
          name: libgdx-raw
          path: artifact/raw

      ####################################
      # SDK ORGANIZADO
      ####################################

      - name: Create SDK structure
        run: |
          SDK=artifact/sdk/libgdx-sdk
          mkdir -p \
            $SDK/core \
            $SDK/backends/{desktop,android,html,ios} \
            $SDK/extensions \
            $SDK/natives/{desktop,android} \
            $SDK/metadata

      - name: Core
        run: |
          cp libgdx-src/gdx/build/libs/*.jar artifact/sdk/libgdx-sdk/core/

      - name: Backends
        run: |
          cp libgdx-src/backends/build/libs/*.jar artifact/sdk/libgdx-sdk/backends/desktop/ || true
          cp libgdx-src/backends/gdx-backend-android/build/outputs/aar/*.aar artifact/sdk/libgdx-sdk/backends/android/ || true
          cp -r libgdx-src/backends/gdx-backends-gwt artifact/sdk/libgdx-sdk/backends/html/ || true
          cp -r libgdx-src/backends/gdx-backend-robovm* artifact/sdk/libgdx-sdk/backends/ios/ || true

      - name: Extensions
        run: |
          cp -r libgdx-src/extensions/* artifact/sdk/libgdx-sdk/extensions/

      - name: Desktop natives
        run: |
          cp -r libgdx-src/gdx-platform/build/natives/* artifact/sdk/libgdx-sdk/natives/desktop/ || true

      - name: Android natives (ABI)
        run: |
          SDK=artifact/sdk/libgdx-sdk/natives/android
          ANDROID=libgdx-src/backends/gdx-backend-android/build
          find $ANDROID -name "*.so" | while read so; do
            ABI=$(echo "$so" | grep -oE 'armeabi-v7a|arm64-v8a|x86|x86_64')
            if [ -n "$ABI" ]; then
              mkdir -p $SDK/$ABI
              cp "$so" $SDK/$ABI/
            fi
          done

      - name: Metadata
        run: |
          META=artifact/sdk/libgdx-sdk/metadata
          echo "libGDX SDK" > $META/version.txt
          echo "Version: $LIBGDX_VERSION" >> $META/version.txt
          date >> $META/version.txt

          echo "Inputs usados:" > $META/inputs.txt
          echo "${{ toJson(github.event.inputs) }}" >> $META/inputs.txt

          tree -d artifact/sdk/libgdx-sdk > $META/structure.txt

      - name: Upload SDK organized
        uses: actions/upload-artifact@v4
        with:
          name: libgdx-sdk-organized
          path: artifact/sdk