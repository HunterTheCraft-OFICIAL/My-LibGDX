name: LibGDX â€“ Build completo + ReorganizaÃ§Ã£o (SDK)

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  reorganize:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Download do artefato bruto
      - name: Download libGDX raw artifact
        uses: actions/download-artifact@v4
        with:
          name: libgdx-raw
          path: input

      # 2ï¸âƒ£ Debug inicial
      - name: Inspect raw artifact
        run: |
          echo "ğŸ“¦ ConteÃºdo bruto:"
          ls -R input

      # 3ï¸âƒ£ Criar estrutura fictÃ­cia do SDK
      - name: Create SDK structure
        run: |
          SDK=output/libgdx-sdk
          mkdir -p \
            $SDK/core \
            $SDK/backends/{desktop,android,html,ios} \
            $SDK/extensions \
            $SDK/natives/{desktop,android} \
            $SDK/metadata

      # 4ï¸âƒ£ Core
      - name: Organize core
        run: |
          SDK=output/libgdx-sdk
          cp input/libgdx/gdx-*.jar $SDK/core/

      # 5ï¸âƒ£ Backends
      - name: Organize backends
        run: |
          SDK=output/libgdx-sdk
          BACKENDS=input/libgdx/backends

          cp $BACKENDS/build/libs/*.jar $SDK/backends/desktop/ || true
          cp $BACKENDS/gdx-backend-android/build/outputs/aar/*.aar $SDK/backends/android/ || true
          cp -r $BACKENDS/gdx-backends-gwt $SDK/backends/html/ || true
          cp -r $BACKENDS/gdx-backend-robovm* $SDK/backends/ios/ || true

      # 6ï¸âƒ£ ExtensÃµes
      - name: Organize extensions
        run: |
          SDK=output/libgdx-sdk
          cp -r input/libgdx/extensions/* $SDK/extensions/

      # 7ï¸âƒ£ Nativos Desktop
      - name: Organize desktop natives
        run: |
          SDK=output/libgdx-sdk
          cp -r input/libgdx/natives/* $SDK/natives/desktop/ || true

      # 8ï¸âƒ£ Nativos Android (ABI-ready)
      - name: Organize Android natives
        run: |
          SDK=output/libgdx-sdk
          ANDROID=input/libgdx/backends/gdx-backend-android/build/intermediates

          mkdir -p $SDK/natives/android

          find $ANDROID -name "*.so" | while read so; do
            ABI=$(echo "$so" | grep -oE 'armeabi-v7a|arm64-v8a|x86|x86_64')
            if [ -n "$ABI" ]; then
              mkdir -p $SDK/natives/android/$ABI
              cp "$so" $SDK/natives/android/$ABI/
            fi
          done

      # 9ï¸âƒ£ Metadata
      - name: Generate metadata
        run: |
          SDK=output/libgdx-sdk
          echo "libGDX SDK (organized)" > $SDK/metadata/version.txt
          date >> $SDK/metadata/version.txt

          tree -d $SDK > $SDK/metadata/structure.txt

      # ğŸ”Ÿ Limpeza de lixo
      - name: Cleanup build leftovers
        run: |
          find output -type d -name build -o -name tmp -o -name intermediates | xargs rm -rf || true

      # 1ï¸âƒ£1ï¸âƒ£ Upload final
      - name: Upload organized SDK
        uses: actions/upload-artifact@v4
        with:
          name: libgdx-sdk-organized
          path: output