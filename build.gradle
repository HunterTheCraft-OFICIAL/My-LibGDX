plugins {
    id 'java'
}

repositories {
    mavenCentral()
    // RepositÃ³rios extras para snapshots e libs nÃ£o publicadas no Maven Central
    maven { url "https://oss.sonatype.org/content/repositories/snapshots/" }
    maven { url "https://jitpack.io" }
}

dependencies {
    // NÃºcleo
    implementation "com.badlogicgames.gdx:gdx:1.12.0"

    // Backends multiplataforma
    implementation "com.badlogicgames.gdx:gdx-backend-lwjgl3:1.12.0"
    implementation "com.badlogicgames.gdx:gdx-backend-gwt:1.12.0"
    implementation "com.badlogicgames.gdx:gdx-backend-robovm:1.12.0"
    // âš ï¸ Android backend nÃ£o Ã© resolvido como JAR, apenas AAR (para Android Studio)
    // implementation "com.badlogicgames.gdx:gdx-backend-android:1.12.0"

    // Nativos
    implementation "com.badlogicgames.gdx:gdx-platform:1.12.0:natives-desktop"
    implementation "com.badlogicgames.gdx:gdx-platform:1.12.0:natives-armeabi-v7a"
    implementation "com.badlogicgames.gdx:gdx-platform:1.12.0:natives-arm64-v8a"
    implementation "com.badlogicgames.gdx:gdx-platform:1.12.0:natives-x86"
    implementation "com.badlogicgames.gdx:gdx-platform:1.12.0:natives-x86_64"
    implementation "com.badlogicgames.gdx:gdx-platform:1.12.0:natives-ios"
    implementation "com.badlogicgames.gdx:gdx-platform:1.12.0:natives-gwt"

    // Extras
    implementation "com.badlogicgames.gdx:gdx-box2d:1.12.0"
    implementation "com.badlogicgames.gdx:gdx-freetype:1.12.0"
    implementation "com.badlogicgames.gdx:gdx-tools:1.12.0"
    implementation "com.badlogicgames.gdx:gdx-ai:1.8.2"
    implementation "com.badlogicgames.gdx:gdx-controllers:1.9.13" // Ãºltima versÃ£o estÃ¡vel publicada no Maven Central
    implementation "com.badlogicgames.gdx:gdx-bullet:1.12.0"

    // Projeto comunitÃ¡rio de Ã¡udio (via JitPack)
    implementation "com.github.barsoosayque:libgdx-oboe:master-SNAPSHOT"

    // âš ï¸ Internos/experimentais (nÃ£o disponÃ­veis no Maven Central)
    // implementation "com.badlogicgames.gdx:gdx-video:1.12.0"
    // implementation "com.badlogicgames.gdx:gdx-jnigen:1.12.0"
    // implementation "com.badlogicgames.gdx:gdx-setup:1.12.0"
    // implementation "com.badlogicgames.gdx:gdx-tests:1.12.0"
}

// Task 1: Checar se dependÃªncias existem (com Busca Profunda)
task checkDependencies {
    doLast {
        def reportFile = file("$buildDir/check-report.txt")
        reportFile.parentFile.mkdirs() // garante diretÃ³rio
        reportFile.text = "=== RELATÃ“RIO DE CHECAGEM ===\n\n"
        def found = 0

        configurations.runtimeClasspath.resolvedConfiguration.resolvedArtifacts.each { artifact ->
            if (artifact.file.exists()) {
                reportFile << "âœ… Encontrada: ${artifact.name} (${artifact.moduleVersion.id.version})\n"
                found++
            } else {
                reportFile << "âš ï¸ NÃ£o encontrada: ${artifact.name} (${artifact.moduleVersion.id.version})\n"
                // Busca Profunda: tenta achar Ãºltima versÃ£o oficial no Maven Central
                try {
                    def metaUrl = "https://repo.maven.apache.org/maven2/com/badlogicgames/gdx/${artifact.name}/maven-metadata.xml"
                    def metaFile = new URL(metaUrl).text
                    def latestMatcher = metaFile =~ /<latest>(.*?)<\/latest>/
                    def releaseMatcher = metaFile =~ /<release>(.*?)<\/release>/
                    if (latestMatcher.find()) {
                        reportFile << "â„¹ï¸ Ãšltima versÃ£o oficial encontrada (latest): ${latestMatcher.group(1)}\n"
                    } else if (releaseMatcher.find()) {
                        reportFile << "â„¹ï¸ Ãšltima versÃ£o oficial encontrada (release): ${releaseMatcher.group(1)}\n"
                    } else {
                        reportFile << "âŒ Nenhuma versÃ£o encontrada nos repositÃ³rios oficiais.\n"
                    }
                } catch(Exception e) {
                    reportFile << "âŒ Falha na Busca Profunda para ${artifact.name}: ${e.message}\n"
                }
            }
        }

        if (found == 0) {
            throw new GradleException("âŒ Nenhuma dependÃªncia encontrada online!")
        }
    }
}

// Task 2: Baixar dependÃªncias (pula falhas)
task downloadDependencies {
    doLast {
        def reportFile = file("$buildDir/download-report.txt")
        reportFile.parentFile.mkdirs() // garante diretÃ³rio
        reportFile.text = "=== RELATÃ“RIO DE DOWNLOAD ===\n\n"
        def success = 0

        configurations.runtimeClasspath.resolvedConfiguration.resolvedArtifacts.each { artifact ->
            try {
                if (artifact.file.exists()) {
                    copy {
                        from artifact.file
                        into "$buildDir/all-libs"
                    }
                    reportFile << "âœ… Sucesso: ${artifact.name} (${artifact.moduleVersion.id.version})\n"
                    success++
                } else {
                    reportFile << "âš ï¸ NÃ£o encontrada: ${artifact.name} (${artifact.moduleVersion.id.version})\n"
                }
            } catch(Exception e) {
                reportFile << "âŒ Falha no download: ${artifact.name} (${artifact.moduleVersion.id.version})\nErro: ${e.message}\n"
            }
        }

        if (success == 0) {
            reportFile << "\nâŒ Nenhuma dependÃªncia foi baixada com sucesso.\n"
        }
    }
}

// Task 3: RelatÃ³rio geral consolidado
task generateReport {
    dependsOn checkDependencies, downloadDependencies
    doLast {
        def reportFile = file("$buildDir/libs-report.txt")
        reportFile.parentFile.mkdirs() // garante diretÃ³rio
        reportFile.text = "=== RELATÃ“RIO CONSOLIDADO ===\n\n"
        def checkReport = file("$buildDir/check-report.txt")
        def downloadReport = file("$buildDir/download-report.txt")

        if (checkReport.exists()) {
            reportFile << checkReport.text + "\n"
        }
        if (downloadReport.exists()) {
            reportFile << downloadReport.text + "\n"
        }

        // adicional: mensagem final amigÃ¡vel
        reportFile << "ðŸ“Œ Fim do relatÃ³rio. Se alguma dependÃªncia nÃ£o foi encontrada, verifique versÃµes mais recentes.\n"
    }
}